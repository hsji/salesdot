<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="projectMapper">

<!-- 매출계약  -->
<select id="searchSP_RequestContract_S02" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_RequestContract_S02
	SELECT  PL.PROJECT_CODE,
	        CL.CONTRACT_NO,
	        CM.COMPANY_NAME AS CLIENT_NAME,
	        PL.PROJECT_NAME,
	        CL.CONTRACT_NAME,
	        VE.EMP_NM AS SALES_EMP_NAME,
	        DATE_FORMAT(CL.CONFIRM_DATE, '%Y-%m-%d') AS CONFIRM_DATE,
	        PD.PRODUCT_NAME,
	        CPD.CONTRACT_PRICE,
	        CL.CO_CD
	FROM    SALES_PROJECT_LIST PL
	JOIN    SALES_CONTRACT_LIST CL  
	        ON CL.PROJECT_CODE = PL.PROJECT_CODE
	        AND CL.CONTRACT_STATUS = '3'
	        -- AND CL.BUSINESS_TYPE = 'U'
	        AND CL.DELETE_FLAG = '0'
	JOIN    SALES_CONTRACT_PRODUCT_DET CPD  
	        ON CPD.CONTRACT_NO = CL.CONTRACT_NO
	        AND CPD.DELETE_FLAG = '0'
	JOIN    SALES_PRODUCT_LIST PD  
	        ON PD.PRODUCT_CODE = CPD.PRODUCT_CODE
	        AND (PD.GOODS_FLAG = '1' 
	        OR LEFT(PD.PRODUCT_CODE, 2) = 'GD')
			-- if test='SERVER_CO_CD != "UNIDIA" '
	        -- AND LEFT(PD.PRODUCT_CODE, 5) != 'P0503'
	        -- if
	        -- AND LEFT(PD.PRODUCT_CODE, 7) != 'G010102'
	JOIN    SALES_COMPANY_LIST CM  
	        ON CM.COMPANY_CODE = PL.CLIENT_CODE
	JOIN    T_SYTM_USER VE  
	        ON VE.EMP_NO = CL.SALES_EMP_NO
	WHERE   CL.CONTRACT_NO IN ( SELECT VALUE
	                            FROM SPLIT_STR(#{CONTRACT_NO}, ','))

</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S01" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S01
	SELECT CL.CONTRACT_TYPE
		 , P.PROJECT_CODE
		 , P.PROJECT_NAME
		 , CL.CONTRACT_NO
		 , CL.CO_CD
		 , CL.BUSINESS_TYPE
		 , CL.CONTRACT_NAME
		 , CL.CONTRACT_MAIN
		 , COM.COMPANY_NAME AS CONTRACT_MAIN_NAME
		 , CL.PRODUCT_CODE
		 , PROD.PRODUCT_NAME AS PRODUCT_NAME
		 , CL.PAY_METHOD
		 , CL.INCENTIVE_EMP_NO
		 , CL.SALES_EMP_NO
		 , (SELECT EMP_NAME FROM F_EMP(#gdsGlobal.LANGUAGE#) WHERE EMP_NO = CL.SALES_EMP_NO) AS SALES_EMP_NAME
		 , CL.CONFIRM_EMP_NO AS CREATE_EMP_NO
		 , (SELECT EMP_NAME FROM F_EMP(#gdsGlobal.LANGUAGE#) WHERE EMP_NO = CL.CONFIRM_EMP_NO) AS CREATE_EMP_NAME
		 , VCP.CONTRACT_PRICE
		 , CL.PREPAYMENT_EXECUTION_RATE
		 , CL.CONTRACT_EXECUTION_RATE
		 , CL.DEFECT_EXECUTION_RATE
		 , DATE_FORMAT(CL.CONTRACT_DATE, '%Y%m%d') AS CONTRACT_DATE
		 , CL.PROGRESS_EXCEPT_FLAG
		 , CL.PROGRESS_100_FLAG
		 , CL.PROGRESS_ADD_FLAG
		 , CL.BAD_DEBT_FLAG
		 , DATE_FORMAT(CL.BAD_DEBT_DATE, '%Y%m%d') AS BAD_DEBT_DATE
		 , CL.EXPORT_FLAG
		 , CASE 
			WHEN CL.CONTRACT_TYPE IN ('P', 'G', 'E') THEN DATE_FORMAT(CP.OPEN_DATE, '%Y%m%d')
			WHEN CL.CONTRACT_TYPE IN ('S', 'T') THEN DATE_FORMAT(CS.OPEN_DATE, '%Y%m%d')
			ELSE NULL
		   END AS OPEN_DATE
		 , (SELECT MAX(DATE_FORMAT(B.ISSUE_DATE, '%Y%m%d'))
			FROM PRODUCT_LICENSE_LIST B
			WHERE B.CONTRACT_NO = CL.CONTRACT_NO
			AND B.ISSUE_DATE IS NOT NULL
		   ) AS ISSUE_DATE
		 , CASE 
			WHEN CL.CONTRACT_TYPE IN ('P', 'G', 'E') THEN DATE_FORMAT(CP.DELIVERY_DATE, '%Y%m%d')
			ELSE NULL
		   END AS DELIVERY_DATE
		 , CASE 
			WHEN CL.CONTRACT_TYPE IN ('P', 'G', 'E') THEN CP.STRATEGY_SALES_FLAG
			WHEN CL.CONTRACT_TYPE IN ('S', 'T') THEN CS.STRATEGY_SALES_FLAG
			ELSE NULL
		   END AS STRATEGY_SALES_FLAG
		 , CP.ANNUAL_FLAG
		 , DATE_FORMAT(
			CASE 
			  WHEN CL.CONTRACT_TYPE = 'M' THEN CM.START_DATE
			  WHEN CL.CONTRACT_TYPE IN ('S', 'T') THEN CS.START_DATE
			  ELSE CP.FREE_MA_START_DATE
			END, '%Y%m%d'
		   ) AS START_DATE
		 , DATE_FORMAT(
			CASE 
			  WHEN CL.CONTRACT_TYPE = 'M' THEN CM.END_DATE
			  WHEN CL.CONTRACT_TYPE IN ('S', 'T') THEN CS.END_DATE
			  ELSE CP.FREE_MA_END_DATE
			END, '%Y%m%d'
		   ) AS END_DATE
		 , DATE_FORMAT(CP.START_DATE, '%Y%m%d') AS START_DATE2
		 , DATE_FORMAT(CP.END_DATE, '%Y%m%d') AS END_DATE2
		 , CASE 
			WHEN CL.CONTRACT_TYPE IN ('P', 'G', 'E') THEN DATE_FORMAT(CP.RESULT_DATE, '%Y%m%d')
			WHEN CL.CONTRACT_TYPE = 'M' THEN DATE_FORMAT(CM.RESULT_DATE, '%Y%m%d')
			ELSE ''
		   END AS RESULT_DATE
		 , CASE 
			WHEN CL.CONTRACT_TYPE IN ('S', 'T') THEN CS.PUBLISHER
			WHEN CL.CONTRACT_TYPE = 'M' THEN CM.PUBLISHER
			ELSE ''
		   END AS PUBLISHER
		 , CS.AREA_CODE
		 , DATE_FORMAT(CS.WITHDRAW_DATE, '%Y%m%d') AS WITHDRAW_DATE
		 , CS.WITHDRAW_EMP_NO
		 , (SELECT EMP_NM FROM T_SYTM_USER WHERE EMP_NO = CS.WITHDRAW_EMP_NO) AS WITHDRAW_EMP_NAME
		 , CM.UNION_FLAG
		 , CM.AUTO_EXTENSION_FLAG
		 , CM.REGULAR_VISIT
		 , CM.ATTACH
		 , CM.REQUEST_PRICE
		 , CM.VIST_CYCLE
		 , CM.REQUEST_CYCLE
		 , CM.REQUEST_MONTH
		 , CM.REQUEST_DAY
		 , CM.AUTO_ISSUE_FLAG
		 , CL.CONSUMPTION_TAX
		 , CL.EM_SEQ
		 , EM.ESTIMATE_NO
		 , PRE_EM.ESTIMATE_NO AS PRE_ESTIMATE_NO
		 , ORG_EM.ESTIMATE_NO AS ORG_ESTIMATE_NO
		 , CL.SITECHK_FLAG
		 , CL.REMARKS
		 , CL.SALES_DEPT_CD
		 , CL.SALES_DEPT_NAME
		 , CL.SALES_CO_CD
		 , CL.CONTRACT_STATUS
		 , CL.SALES_STATUS
		 , CL.COLLECTION_BOND_FLAG
		 , CL.CLIENT_PO_NO
		 , IFNULL(CSD.MEN_MONTH, 0) AS MEN_MONTH
		 , CP.DISCOUNT_RATE
		 , CS.PROFITS_RATE
		 , CL.SUB_SALES_EMP_NO
		 , CL.SUB_CONTRACT_PRICE
		 , CL.NET_SALES_FLAG
		 , CL.DIVISION_FLAG
		 -- , IFNULL(VRI.ROYALTY_PRICE, 0) AS ROYALTY_PRICE
	FROM SALES_PROJECT_LIST P
	JOIN SALES_CONTRACT_LIST CL ON (P.PROJECT_CODE = CL.PROJECT_CODE
	 AND CL.DELETE_FLAG = '0'
	 AND CL.CO_CD = #{SERVER_CO_CD})
	LEFT JOIN SALES_CONTRACT_PRODUCT CP ON (CL.CONTRACT_NO = CP.CONTRACT_NO)
	LEFT JOIN SALES_CONTRACT_SI CS ON (CL.CONTRACT_NO = CS.CONTRACT_NO)
	LEFT JOIN (SELECT CONTRACT_NO
				  , SUM(MEN_MONTH) AS MEN_MONTH
			   FROM SALES_CONTRACT_SI_DET
			   WHERE DELETE_FLAG = '0'
			   GROUP BY CONTRACT_NO
			  ) CSD ON (CS.CONTRACT_NO = CSD.CONTRACT_NO)
	LEFT JOIN SALES_CONTRACT_MA CM ON (CL.CONTRACT_NO = CM.CONTRACT_NO)
	LEFT JOIN (SELECT CONTRACT_NO
				  , MIN(START_DATE) AS START_DATE
				  , MAX(END_DATE) AS END_DATE
			   FROM SALES_CONTRACT_MA_DET
			   WHERE DELETE_FLAG = '0'
			   GROUP BY CONTRACT_NO
			  ) CMD ON (CM.CONTRACT_NO = CMD.CONTRACT_NO)
	LEFT JOIN SALES_ESTIMATE_MANGEMENT EM ON(CL.EM_SEQ = EM.EM_SEQ)
	LEFT JOIN SALES_ESTIMATE_MANGEMENT PRE_EM ON(EM.PRE_EM_SEQ = PRE_EM.EM_SEQ)
	LEFT JOIN SALES_ESTIMATE_MANGEMENT ORG_EM ON(EM.ORG_EM_SEQ = ORG_EM.EM_SEQ)
	LEFT JOIN V_CONTRACT_PRICE VCP ON (CL.CONTRACT_NO = VCP.CONTRACT_NO)
	LEFT JOIN SALES_COMPANY_LIST COM ON (CL.CONTRACT_MAIN = COM.COMPANY_CODE)
	LEFT JOIN SALES_PRODUCT_LIST PROD ON (CL.PRODUCT_CODE = PROD.PRODUCT_CODE)
	LEFT JOIN V_EMP VE ON (CS.WITHDRAW_EMP_NO = VE.EMP_NO)
	--LEFT JOIN T_SYTM_CODE CD ON (CL.CONTRACT_TYPE = CD.SSC_CD
	-- AND CD.HCL_CD = 'CONTRACT_TYPE'
	-- AND CD.GRP_CD_1 = '1')
	-- LEFT JOIN V_ROYALTY_INFO VRI ON VRI.CONTRACT_NO = CL.CONTRACT_NO
	WHERE P.DELETE_FLAG = '0'
	  AND CL.CONTRACT_STATUS = '3'
	  AND P.PROJECT_CODE = #{PROJECT_CODE}
	ORDER BY CASE
			 WHEN CL.CONTRACT_TYPE = 'PD' THEN '001'
			 WHEN CL.CONTRACT_TYPE = 'GD' THEN '002'
			 WHEN CL.CONTRACT_TYPE = 'ZS' THEN '003'
			 WHEN CL.CONTRACT_TYPE = 'ZT' THEN '003'
			 WHEN CL.CONTRACT_TYPE = 'SM' THEN '004'
			 WHEN CL.CONTRACT_TYPE = 'ET' THEN '005'
			 ELSE '006'
			END, CL.CONTRACT_DATE
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S03" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S03
	SELECT A.PROJECT_CODE
		 , A.CONTRACT_NO
		 , CL.CONTRACT_NAME
		 , A.CLIENT_CODE
		 , COM.COMPANY_NAME AS CLIENT_NAME
		 , CMU.UNION_CONTRACT_NO
	FROM (
		SELECT P.PROJECT_CODE, P.CLIENT_CODE, MAX(CL.CONTRACT_NO) AS CONTRACT_NO
		FROM SALES_PROJECT_LIST P
		JOIN SALES_CONTRACT_LIST CL
		  ON P.PROJECT_CODE = CL.PROJECT_CODE
		 AND CL.DELETE_FLAG = '0'
		JOIN SALES_CONTRACT_MA CM
		  ON CL.CONTRACT_NO = CM.CONTRACT_NO
		WHERE P.DELETE_FLAG = '0'
		  AND P.PROJECT_CODE != #{PROJECT_CODE}
		GROUP BY P.PROJECT_CODE, P.CLIENT_CODE
	) A
	JOIN SALES_CONTRACT_LIST CL
	  ON A.CONTRACT_NO = CL.CONTRACT_NO
	JOIN SALES_CONTRACT_MA_UNION CMU
	  ON A.CONTRACT_NO = CMU.CONTRACT_NO
	LEFT JOIN SALES_COMPANY_LIST COM
	  ON A.CLIENT_CODE = COM.COMPANY_CODE
	WHERE CMU.UNION_CONTRACT_NO = #{UNION_CONTRACT_NO}	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_sales_schedule" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_sales_schedule
	SELECT SS.SS_SEQ
		 , SS.PROJECT_CODE
		 , SS.CONTRACT_NO
		 , SS.TYPE_CODE
		 , DATE_FORMAT(SS.ISSUE_DATE, '%Y%m%d') AS ISSUE_DATE
		 , SS.REPORT_FLAG
		 , SS.IMPORTANCE
		 , SS.OPEN_FLAG
		 , SS.CONTENTS
	FROM SALES_SCHEDULE SS
	WHERE SS.PROJECT_CODE = #{PROJECT_CODE}
	  AND (SS.CONTRACT_NO = #{CONTRACT_NO} OR SS.CONTRACT_NO IS NULL)
	ORDER BY SS.ISSUE_DATE DESC	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_company_addressbook" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_company_addressbook
	SELECT CAM.SOURCE_CD
	     , CAM.SOURCE_DATA
	     , CAM.CA_SEQ
	     , CA.COMPANY_CODE
	     , (SELECT COMPANY_NAME 
	        FROM SALES_COMPANY_LIST 
	        WHERE COMPANY_CODE = CA.COMPANY_CODE) AS COMPANY_NAME
	     , CA.EMP_NAME
	     , CA.DEPT_NAME
	     , CA.GRADE_CODE
	     , CA.ROLE_CODE
	     , CA.H_PHONE_NO
	     , CA.O_PHONE_NO
	     , CA.HOLD_OFFICE
	     , CA.EMAIL
	     , CA.ETAX_FLAG
	     , CA.ORDER_FLAG
	     , CA.REMARKS
	     , CAM.INPT_DTTM AS INSERT_DATE
	     , CAM.INPT_ID AS INSERT_EMP_NO
	     , VE.EMP_NM AS INSERT_EMP_NAME
	FROM SALES_CA_MAP CAM
	JOIN SALES_COMPANY_ADDRESSBOOK CA  
	    ON CAM.CA_SEQ = CA.CA_SEQ
	JOIN T_SYTM_USER VE  
	    ON VE.EMP_NO = CAM.INPT_ID
	WHERE ((CAM.SOURCE_CD = 'PL' AND CAM.SOURCE_DATA = #{PROJECT_CODE})
	   OR  (CAM.SOURCE_CD = 'CL' AND CAM.SOURCE_DATA = #{CONTRACT_NO}))	    
	ORDER BY CAM.CA_SEQ	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_contract_promise" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_contract_promise
	SELECT CP_SEQ
		 , CONTRACT_NO
		 , SUBJECT
		 , DATE_FORMAT(PROMISE_DATE, '%Y%m%d') AS PROMISE_DATE
		 , DATE_FORMAT(LIMIT_DATE, '%Y%m%d') AS LIMIT_DATE
		 , PROMISE_KIND
		 , CONTENTS
	FROM SALES_CONTRACT_PROMISE
	WHERE CONTRACT_NO = #{CONTRACT_NO};	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_contract_ma_union" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_contract_ma_union
	SELECT CMU.CONTRACT_NO
		 , CMU.UNION_CONTRACT_NO
		 , PL.PROJECT_CODE AS UNION_PROJECT_CODE
		 , PL.PROJECT_NAME AS UNION_PROJECT_NAME
		 , CL.CONTRACT_NAME AS UNION_CONTRACT_NAME
		 , PD.PRODUCT_NAME
		 , PL.CLIENT_CODE
		 , COM.COMPANY_NAME AS CLIENT_NAME
		 , IFNULL(CP.SUPPORT_STATUS, '004') AS SUPPORT_STATUS
		 , CP.SUPPORT_STOP_START_DATE
		 , CP.SUPPORT_STOP_END_DATE
		 , CP.SUPPORT_REMARKS
		 , SSH.SSH_SEQ
		 , NULL AS ORG_SUPPORT_STATUS
	FROM SALES_CONTRACT_MA_UNION CMU
	JOIN SALES_CONTRACT_LIST CL ON CMU.UNION_CONTRACT_NO = CL.CONTRACT_NO
	  AND CL.DELETE_FLAG = '0'
	JOIN SALES_PROJECT_LIST PL ON CL.PROJECT_CODE = PL.PROJECT_CODE
	  AND PL.DELETE_FLAG = '0'
	LEFT JOIN SALES_COMPANY_LIST COM ON PL.CLIENT_CODE = COM.COMPANY_CODE
	LEFT JOIN SALES_PRODUCT_LIST PD ON CL.PRODUCT_CODE = PD.PRODUCT_CODE
	LEFT JOIN SALES_CONTRACT_PRODUCT CP ON CP.CONTRACT_NO = CMU.UNION_CONTRACT_NO
	LEFT JOIN (
		SELECT CONTRACT_NO
			 , MAX(SSH_SEQ) AS SSH_SEQ
		FROM SALES_SUPPORT_STATUS_HISTORY
		GROUP BY CONTRACT_NO
	) SSH ON SSH.CONTRACT_NO = CP.CONTRACT_NO
	WHERE CMU.CONTRACT_NO = #{CONTRACT_NO};	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_contract_prod_det" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_contract_prod_det
	SELECT CRD.CRD_SEQ
		 , CRD.CONTRACT_NO
		 , CRD.PRODUCT_CODE
		 , PL.PRODUCT_NAME
		 -- , PLI.PRODUCT_VERSION
		 , PL.PRODUCT_NAME_SHORT
		 , CASE WHEN LENGTH(CRD.PRODUCT_LIST) > 0 THEN '<![CDATA[[]]>' ELSE '' END +
		   CASE WHEN REPLACE(CRD.PRODUCT_LIST, '0', '') != CRD.PRODUCT_LIST THEN 'S' ELSE '' END +
		   CASE WHEN REPLACE(CRD.PRODUCT_LIST, '1', '') != CRD.PRODUCT_LIST THEN 'T' ELSE '' END +
		   CASE WHEN REPLACE(CRD.PRODUCT_LIST, '2', '') != CRD.PRODUCT_LIST THEN 'C' ELSE '' END +
		   CASE WHEN LENGTH(CRD.PRODUCT_LIST) > 0 THEN '<![CDATA[] ]]>' ELSE '' END + PL.PRODUCT_NAME AS PRODUCT_LIST_NAME
		 , CRD.PRODUCT_LIST
		 , CRD.PLATFORM_LIST
		 , CRD.FUNCTION_LIST
		 , CRD.PURPOSE
		 , CRD.ISDEV_FLAG
		 , CRD.SERVER_GRADE
		 , CRD.PRODUCT_TYPE
		 , CRD.UNIT_COST
		 , CRD.PRODUCT_UNIT
		 , CRD.QUANTITY
		 , CRD.CONTRACT_PRICE
		 , CRD.REMARKS
		 , CRD.DELETE_FLAG
		 , CRD.ORD
	FROM SALES_CONTRACT_PRODUCT_DETAIL CRD
	LEFT JOIN SALES_PRODUCT_LIST PL ON CRD.PRODUCT_CODE = PL.PRODUCT_CODE
	-- LEFT JOIN SALES_PRODUCT_LICENSE_INFO PLI ON PL.PRODUCT_CODE = PLI.PRODUCT_CODE
	WHERE CRD.DELETE_FLAG = '0'
	  AND CRD.CONTRACT_NO = #{CONTRACT_NO}
	ORDER BY CAST(CRD.ORD AS UNSIGNED);	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_contract_ma_det" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_contract_ma_det
	SELECT CMD.CMD_SEQ
		 , CMD.CONTRACT_NO
		 , CMD.PRODUCT_CODE
		 , PL.PRODUCT_NAME
		 , CMD.MA_PRODUCT_CODE
		 , PL2.PRODUCT_NAME AS MA_PRODUCT_NAME
		 , DATE_FORMAT(CMD.START_DATE, '%Y%m%d') AS START_DATE
		 , DATE_FORMAT(CMD.END_DATE, '%Y%m%d') AS END_DATE
		 , CMD.CONTRACT_PRICE
		 , CMD.MA_RATE
		 , CMD.MA_STANDARD
		 , CMD.REMARKS
		 , CMD.DELETE_FLAG
		 , CMD.ORD
		 , CMD.PURCHASE_EXCEPT_FLAG
	FROM SALES_CONTRACT_MA_DETAIL CMD
	LEFT JOIN SALES_PRODUCT_LIST PL ON CMD.PRODUCT_CODE = PL.PRODUCT_CODE
	LEFT JOIN SALES_PRODUCT_LIST PL2 ON CMD.MA_PRODUCT_CODE = PL2.PRODUCT_CODE
	WHERE CMD.DELETE_FLAG = '0'
	  AND CMD.CONTRACT_NO = #{CONTRACT_NO}
	ORDER BY CAST(CMD.ORD AS UNSIGNED);
	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_contract_si_det" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_contract_si_det
	SELECT CSD.CSD_SEQ
		 , CSD.CONTRACT_NO
		 , CSD.ROLE_CODE
		 , CSD.LEVEL_CODE
		 , IFNULL(LUC.UNIT_COST, 0) AS LEVEL_UNIT_COST
		 , DATE_FORMAT(CSD.START_DATE, '%Y%m%d') AS START_DATE
		 , DATE_FORMAT(CSD.END_DATE, '%Y%m%d') AS END_DATE
		 , CSD.PERSON_NUMBER
		 , CSD.UNIT_COST
		 , CSD.CONTRACT_PRICE
		 , CSD.MEN_MONTH
		 , CSD.AREA_CODE
		 , CSD.REMARKS
		 , CSD.DELETE_FLAG
		 , CSD.ORD
		 , CSD.EXECUTION_TYPE
		 , CSD.TECH_SUPPORT_UNIT
	FROM SALES_CONTRACT_SI_DET CSD
	JOIN SALES_CONTRACT_LIST CL
	  ON CSD.CONTRACT_NO = CL.CONTRACT_NO
	LEFT JOIN SALES_LEVEL_UNIT_COST LUC
	  ON DATE_FORMAT(CL.CONTRACT_DATE, '%Y') = LUC.YEAR
	  AND CSD.LEVEL_CODE = LUC.LEVEL_CODE
	  AND LUC.LEVEL_TYPE = 'S'
	WHERE CSD.DELETE_FLAG = '0'
	  AND CSD.CONTRACT_NO = #{CONTRACT_NO}
	ORDER BY CAST(CSD.ORD AS UNSIGNED), CSD.CSD_SEQ;	
</select>

<!-- 매출계약  -->
<select id="searchSP_Contract_S02_TOBE_ROYALTY_SELECT" parameterType="java.util.Map" resultType="java.util.Map">
	-- searchSP_Contract_S02_TOBE_ROYALTY_SELECT 추후
	SELECT RI.PROJECT_CODE
		 , RI.CONTRACT_NO
		 , NULL AS CONTRACT_TYPE
		 , RI.ROYALTY_SEQ
		 , RI.ROYALTY_CONTRACT_NO
		 , RI.CONTRACT_NO_PURCHASE
		 , RI.ROYALTY_TYPE
		 , IFNULL(RI.ROYALTY_RATE, 0) AS ROYALTY_RATE
		 , DATE_FORMAT(RI.ROYALTY_DATE, '%Y%m%d') AS ROYALTY_DATE
		 , VCP.CONTRACT_PRICE
		 , RI.ROYALTY_PRICE_KOR AS ROYALTY_PRICE
		 , RI.ROYALTY_PRICE_KOR
		 , RI.NET_SALES_PRICE
		 , IFNULL(RI.CONFIRM_FLAG, '0') AS CONFIRM_FLAG
		 , RI.EXCHAGE_STATUS
		 , (SELECT EXCHAGE_RATE
			FROM F_EXCHAGE_RATE(DATE_FORMAT(RI.ROYALTY_DATE, '%Y%m'), '001', '002')) AS EXCHAGE_RATE
		 , RI.ROYALTY_REMARKS_KOR AS ROYALTY_REMARKS
		 , RI.REMARKS_KOR AS REMARKS
		 , RI.ROYALTY_REMARKS_KOR
		 , RI.REMARKS_KOR
		 , RI.BILL_REMARKS
		 , RI.ROYALTY_CONTRACT_NO AS CONTRACT_NO_KOR
		 , RI.CONTRACT_NAME_KOR
		 , DATE_FORMAT(RI.TAX_PLAN_DATE, '%Y%m%d') AS TAX_PLAN_DATE
		 , DATE_FORMAT(RI.TAX_DATE, '%Y%m%d') AS TAX_DATE
		 , DATE_FORMAT(RI.BILL_PLAN_DATE, '%Y%m%d') AS BILL_PLAN_DATE
	FROM V_ROYALTY_INFO RI
	LEFT JOIN V_CONTRACT_PRICE VCP
	  ON RI.CONTRACT_NO = VCP.CONTRACT_NO
	WHERE RI.ROYALTY_CONTRACT_NO = #{CONTRACT_NO};	
</select>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_LIST_I_U" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_LIST_I_U
	INSERT INTO SALES_CONTRACT_LIST
	( 
		CONTRACT_NO
	 , CO_CD
	 , PROJECT_CODE
	 , CONTRACT_TYPE
	 , BUSINESS_TYPE
	 , CONTRACT_NAME
	 , PRODUCT_CODE
	 , CONTRACT_DATE
	 , SALES_EMP_NO
	 , SALES_DEPT_CD
	 , SALES_DEPT_NAME
	 , SALES_CO_CD
	 , SUB_SALES_EMP_NO
	 , SUB_CONTRACT_PRICE
	 , INCENTIVE_EMP_NO
	 , CONTRACT_STATUS
	 , SALES_STATUS
	 , PIPELINE_FLAG
	 , CONTRACT_MAIN
	 , SITECHK_FLAG
	 , EXPORT_FLAG
	 , PAY_METHOD
	 <if test="PREPAYMENT_EXECUTION_RATE != null and PREPAYMENT_EXECUTION_RATE != '' ">
	 , PREPAYMENT_EXECUTION_RATE
	 </if>
	 <if test="CONTRACT_EXECUTION_RATE != null and CONTRACT_EXECUTION_RATE != '' ">
	 , CONTRACT_EXECUTION_RATE
	 </if>
	 <if test="DEFECT_EXECUTION_RATE != null and DEFECT_EXECUTION_RATE != '' ">
	 , DEFECT_EXECUTION_RATE
	 </if>
	 , PROGRESS_EXCEPT_FLAG
	 , PROGRESS_100_FLAG
	 , PROGRESS_ADD_FLAG
	 , BAD_DEBT_FLAG
	 , BAD_DEBT_DATE
	 , COLLECTION_BOND_FLAG
	 , NET_SALES_FLAG
	 , DIVISION_FLAG
	 , CONSUMPTION_TAX
	 <if test="REMARKS != null and REMARKS != '' ">
	 , REMARKS
	 </if>
	 , CLIENT_PO_NO
	 , CONFIRM_EMP_NO
	 , CONFIRM_DATE
	 , DELETE_FLAG
	 , EM_SEQ
	 , REAL_CONTRACT_FLAG
		, INPT_ID
		, INPT_IP
		, INPT_DTTM
		, CHGE_ID
		, CHGE_IP
		, CHGE_DTTM
	)
	VALUES
	( 
		#{varContractNo}
	 , #{SERVER_CO_CD}
	 , #{PROJECT_CODE}
	 , #{CONTRACT_TYPE}
	 , #{BUSINESS_TYPE}
	 , #{CONTRACT_NAME}
	 , #{PRODUCT_CODE}
	 , #{CONTRACT_DATE}
	 , #{SALES_EMP_NO}
	 , #{SALES_DEPT_CD}
	 , #{SALES_DEPT_NAME}
	 , #{SALES_CO_CD}
	 , #{SUB_SALES_EMP_NO}
	 , #{SUB_CONTRACT_PRICE}
	 , #{INCENTIVE_EMP_NO}
	 , '3'
	 , #{SALES_STATUS}
	 , '0'
	 , #{CONTRACT_MAIN}
	 , #{SITECHK_FLAG}
	 , #{EXPORT_FLAG}
	 , #{PAY_METHOD}
	  <if test="PREPAYMENT_EXECUTION_RATE != null and PREPAYMENT_EXECUTION_RATE != '' ">
	 , #{PREPAYMENT_EXECUTION_RATE}
	  </if>
	  <if test="CONTRACT_EXECUTION_RATE != null and CONTRACT_EXECUTION_RATE != '' ">
	 , #{CONTRACT_EXECUTION_RATE}
	  </if>
	  <if test="DEFECT_EXECUTION_RATE != null and DEFECT_EXECUTION_RATE != '' ">
	 , #{DEFECT_EXECUTION_RATE}
	  </if>
	 , #{PROGRESS_EXCEPT_FLAG}
	 , #{PROGRESS_100_FLAG}
	 , #{PROGRESS_ADD_FLAG}
	 , #{BAD_DEBT_FLAG}
	 , #{BAD_DEBT_DATE}
	 , #{COLLECTION_BOND_FLAG}
	 , #{NET_SALES_FLAG}
	 , #{DIVISION_FLAG}
	 , #{CONSUMPTION_TAX}
	  <if test="REMARKS != null and REMARKS != '' ">
	 , #{REMARKS}
	  </if>
	 , #{CLIENT_PO_NO}
	 , #{EMP_NO_SRV}
	 , NOW()
	 , '0'
	 , #{EM_SEQ}
	 , '1'
		,#{EMP_NO_SRV}
		,#{USER_CON_IPADDR_SRV}
		,NOW()
		,#{EMP_NO_SRV}
		,#{USER_CON_IPADDR_SRV}
		,NOW()	 
	);

</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_LIST_I_U" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_LIST_I_U

	UPDATE SALES_CONTRACT_LIST
	SET
	    CONTRACT_NAME = #{CONTRACT_NAME},
	    CONTRACT_TYPE = #{CONTRACT_TYPE},
	    BUSINESS_TYPE = #{BUSINESS_TYPE},
	    PRODUCT_CODE = #{PRODUCT_CODE},
	    CONTRACT_DATE = #{CONTRACT_DATE},
	    SALES_EMP_NO = #{SALES_EMP_NO},
	    SALES_CO_CD = #{SALES_CO_CD},
	    SUB_SALES_EMP_NO = #{SUB_SALES_EMP_NO},
	    SUB_CONTRACT_PRICE = #{SUB_CONTRACT_PRICE},
	    INCENTIVE_EMP_NO = #{INCENTIVE_EMP_NO},
	    CONTRACT_MAIN = #{CONTRACT_MAIN},
	    SITECHK_FLAG = #{SITECHK_FLAG},
	    EXPORT_FLAG = #{EXPORT_FLAG},
	    PAY_METHOD = #{PAY_METHOD},
	    PROGRESS_EXCEPT_FLAG = #{PROGRESS_EXCEPT_FLAG},
	    PROGRESS_100_FLAG = #{PROGRESS_100_FLAG},
	    PROGRESS_ADD_FLAG = #{PROGRESS_ADD_FLAG},
	    BAD_DEBT_FLAG = #{BAD_DEBT_FLAG},
	    BAD_DEBT_DATE = #{BAD_DEBT_DATE},
	    COLLECTION_BOND_FLAG = #{COLLECTION_BOND_FLAG},
	    NET_SALES_FLAG = #{NET_SALES_FLAG},
	    DIVISION_FLAG = #{DIVISION_FLAG},
	    SALES_STATUS = #{SALES_STATUS},
	    CLIENT_PO_NO = #{CLIENT_PO_NO},
		<if test="PREPAYMENT_EXECUTION_RATE != null and PREPAYMENT_EXECUTION_RATE != '' ">
	    PREPAYMENT_EXECUTION_RATE = #{PREPAYMENT_EXECUTION_RATE},
		</if>
		<if test="CONTRACT_EXECUTION_RATE != null and CONTRACT_EXECUTION_RATE != '' ">
	    CONTRACT_EXECUTION_RATE = #{CONTRACT_EXECUTION_RATE},
		</if>
		<if test="DEFECT_EXECUTION_RATE != null and DEFECT_EXECUTION_RATE != '' ">
	    DEFECT_EXECUTION_RATE = #{DEFECT_EXECUTION_RATE},
		</if>
	    CONSUMPTION_TAX = #{CONSUMPTION_TAX},
		<if test="REMARKS != null and REMARKS != '' ">
	    REMARKS = #{REMARKS},
		</if>
	    EM_SEQ = #{EM_SEQ},
		CHGE_ID = #{EMP_NO_SRV},
		CHGE_IP = #{USER_CON_IPADDR_SRV},
		CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{CONTRACT_NO};
	
	UPDATE SALES_PURCHASE_LIST
	SET
	    NET_SALES_FLAG = #{NET_SALES_FLAG},
		CHGE_ID = #{EMP_NO_SRV},
		CHGE_IP = #{USER_CON_IPADDR_SRV},
		CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{CONTRACT_NO};
</update>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_PRODUCT" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_PRODUCT
	INSERT INTO SALES_CONTRACT_PRODUCT
	(
		CONTRACT_NO,
		FREE_MA_START_DATE,
		FREE_MA_END_DATE,
		DELIVERY_DATE,
		OPEN_DATE,
		ANNUAL_FLAG,
		START_DATE,
		END_DATE,
		RESULT_DATE,
		STRATEGY_SALES_FLAG,
		SUPPORT_STATUS,
		DISCOUNT_RATE
			, INPT_ID
			, INPT_IP
			, INPT_DTTM
			, CHGE_ID
			, CHGE_IP
			, CHGE_DTTM
	) VALUES
	(
		#{varContractNo},
		#{START_DATE},
		#{END_DATE},
		#{DELIVERY_DATE},
		#{OPEN_DATE},
		#{ANNUAL_FLAG},
		#{START_DATE2},
		#{END_DATE2},
		#{RESULT_DATE},
		#{STRATEGY_SALES_FLAG},
		'004',
		#{DISCOUNT_RATE},
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	 
	);
	
</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_PRODUCT" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_PRODUCT
	UPDATE SALES_CONTRACT_PRODUCT
	 SET
	 <if test="FREE_MA_START_DATE != null and FREE_MA_START_DATE != ''">
	 FREE_MA_START_DATE = #{START_DATE}
	 </if>
	 <if test="FREE_MA_END_DATE != null and FREE_MA_END_DATE != ''">
	 , FREE_MA_END_DATE = #{END_DATE}
	 </if>
	 <if test="DELIVERY_DATE != null and DELIVERY_DATE != ''">
	 , DELIVERY_DATE = #{DELIVERY_DATE}
	 </if>
	 <if test="OPEN_DATE != null and OPEN_DATE != ''">
	 , OPEN_DATE = #{OPEN_DATE}
	 </if>
	 <if test="START_DATE2 != null and START_DATE2 != ''">
	 , START_DATE = #{START_DATE2}
	 </if>
	 <if test="END_DATE2 != null and END_DATE2 != ''">
	 , END_DATE = #{END_DATE2}
	 </if>
	 <if test="RESULT_DATE != null and RESULT_DATE != ''">
	 , RESULT_DATE = #{RESULT_DATE}
	 </if>
	 , ANNUAL_FLAG = #{ANNUAL_FLAG}
	 , STRATEGY_SALES_FLAG = #{STRATEGY_SALES_FLAG}
	 , DISCOUNT_RATE = #{DISCOUNT_RATE}
			, CHGE_ID = #{EMP_NO_SRV}
			, CHGE_IP = #{USER_CON_IPADDR_SRV}
			, CHGE_DTTM = NOW()
	 WHERE CONTRACT_NO = #{CONTRACT_NO};
	 
	 /*	검수 상태 일괄 변경 처리 */
	 UPDATE CONTRACT_BILL
	 SET
		<choose>
			<when test=' SITECHK_FLAG == "1" '>
				SITECHK_STATUS = '002'
			</when>
			<otherwise>
				SITECHK_STATUS = '001'
			</otherwise>
		</choose>	
	 WHERE CB_SEQ IN (
		 SELECT CB_SEQ
		 FROM SALES_CONTRACT_BILL
		 WHERE CONTRACT_NO = #{CONTRACT_NO}
			<choose>
				<when test=' SITECHK_FLAG == "1" '>
					AND SITECHK_STATUS = '001'
				</when>
				<otherwise>
					AND SITECHK_STATUS = '002'
				</otherwise>
			</choose> 
	 );	
</update>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_SI" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_SI
	INSERT INTO SALES_CONTRACT_SI
	(
		CONTRACT_NO,
		START_DATE,
		END_DATE,
		STRATEGY_SALES_FLAG,
		OPEN_DATE,
		WITHDRAW_DATE,
		WITHDRAW_EMP_NO,
		AREA_CODE,
		PUBLISHER,
		PROFITS_RATE,
				 INPT_ID
				, INPT_IP
				, INPT_DTTM
				, CHGE_ID
				, CHGE_IP
				, CHGE_DTTM
	)
	VALUES
	(
		#{varContractNo},
		#{START_DATE},
		#{END_DATE},
		IFNULL(#{STRATEGY_SALES_FLAG}, '0'),  -- '0'으로 기본값 설정
		#{OPEN_DATE},
		#{WITHDRAW_DATE},
		#{WITHDRAW_EMP_NO},
		#{AREA_CODE},
		#{PUBLISHER},
		#{PROFITS_RATE},
				 #{EMP_NO_SRV}
				,#{USER_CON_IPADDR_SRV}
				,NOW()
				,#{EMP_NO_SRV}
				,#{USER_CON_IPADDR_SRV}
				,NOW()	 
	);
	
</insert>
<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_SI" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_SI
	UPDATE SALES_CONTRACT_SI
	SET
		STRATEGY_SALES_FLAG = IFNULL(#{STRATEGY_SALES_FLAG}, '0'),  -- NULL일 경우 '0'으로 설정
		START_DATE = NULLIF(#{START_DATE}, ''),  -- 빈 문자열일 경우 NULL로 설정
		END_DATE = NULLIF(#{END_DATE}, ''),  -- 빈 문자열일 경우 NULL로 설정
		OPEN_DATE = NULLIF(#{OPEN_DATE}, ''),  -- 빈 문자열일 경우 NULL로 설정
		WITHDRAW_DATE = NULLIF(#{WITHDRAW_DATE}, ''),  -- 빈 문자열일 경우 NULL로 설정
		WITHDRAW_EMP_NO = #{WITHDRAW_EMP_NO},
		AREA_CODE = #{AREA_CODE},
		PUBLISHER = #{PUBLISHER},
		PROFITS_RATE = #{PROFITS_RATE},
		CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{CONTRACT_NO};

	/* 검수 상태 일괄 변경 처리 */
	UPDATE SALES_CONTRACT_BILL
	SET
		SITECHK_STATUS = CASE 
			WHEN #{SITECHK_FLAG} = 1 THEN '002'
			ELSE '001'
		END
	WHERE CB_SEQ IN (
		SELECT CB_SEQ
		FROM CONTRACT_BILL
		WHERE CONTRACT_NO = #{CONTRACT_NO}
		AND (
			( #{SITECHK_FLAG} = 1 AND SITECHK_STATUS = '001' )
			OR ( #{SITECHK_FLAG} <![CDATA[<>]]> 1 AND SITECHK_STATUS = '002' )
		) 
	);

</update>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_MA" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_MA
	INSERT INTO SALES_CONTRACT_MA (
		CONTRACT_NO,
		START_DATE,
		END_DATE,
		UNION_FLAG,
		AUTO_EXTENSION_FLAG,
		REGULAR_VISIT,
		ATTACH,
		PUBLISHER,
		VIST_CYCLE,
		REQUEST_CYCLE,
		REQUEST_PRICE,
		REQUEST_MONTH,
		REQUEST_DAY,
		RESULT_DATE,
		AUTO_ISSUE_FLAG
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM
	) VALUES (
		#{varContractNo},
		#{START_DATE},
		#{END_DATE},
		#{UNION_FLAG},
		#{AUTO_EXTENSION_FLAG},
		#{REGULAR_VISIT},
		#{ATTACH},
		#{PUBLISHER},
		#{VIST_CYCLE},
		#{REQUEST_CYCLE},
		#{REQUEST_PRICE},
		#{REQUEST_MONTH},
		#{REQUEST_DAY},
		IFNULL(STR_TO_DATE(#{RESULT_DATE}, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(#{CONTRACT_DATE}, '%Y-%m-%d %H:%i:%s')) ,  -- NULL일 경우 CONTRACT_DATE 사용
		#{AUTO_ISSUE_FLAG},
	    #{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()		
	);

	INSERT INTO SALES_CONTRACT_MA_HISTORY (
		CONTRACT_NO,
		REGULAR_VISIT,
		VIST_CYCLE,
		 INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM
	)
	SELECT
		CONTRACT_NO,
		REGULAR_VISIT,
		VIST_CYCLE,
	    #{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()	
	FROM CONTRACT_MA
	WHERE CONTRACT_NO = #{varContractNo};	
</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_MA" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_MA
	
	UPDATE SALES_CONTRACT_MA
	SET
	    UNION_FLAG = #{UNION_FLAG},
		<if test="START_DATE !=null and START_DATE != ''">
		START_DATE = #{START_DATE},
		</if>
		<if test="END_DATE !=null and END_DATE != ''">
		END_DATE = #{END_DATE},
		</if>
		<if test="RESULT_DATE !=null and RESULT_DATE != ''">
		RESULT_DATE = #{RESULT_DATE},
		</if>
	    AUTO_EXTENSION_FLAG = #{AUTO_EXTENSION_FLAG},
	    REGULAR_VISIT = #{REGULAR_VISIT},
	    ATTACH = #{ATTACH},
	    PUBLISHER = #{PUBLISHER},
	    VIST_CYCLE = #{VIST_CYCLE},
	    REQUEST_CYCLE = #{REQUEST_CYCLE},
	    REQUEST_PRICE = #{REQUEST_PRICE},
	    REQUEST_MONTH = #{REQUEST_MONTH},
	    REQUEST_DAY = #{REQUEST_DAY},
	    AUTO_ISSUE_FLAG = #{AUTO_ISSUE_FLAG}
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{CONTRACT_NO};
	
	-- 검수 상태 일괄 변경 처리
	UPDATE SALES_CONTRACT_BILL
	SET
	    SITECHK_STATUS = CASE 
	        WHEN #{SITECHK_FLAG} = 1 THEN '002'
	        ELSE '001' 
	    END
	WHERE CB_SEQ IN (
	    SELECT CB_SEQ
	    FROM CONTRACT_BILL
	    WHERE CONTRACT_NO = #{CONTRACT_NO}
	    AND (
	        ( #{SITECHK_FLAG} = 1 AND SITECHK_STATUS = '001' ) OR
	        ( #{SITECHK_FLAG} <![CDATA[<>]]> 1 AND SITECHK_STATUS = '002' )
	    )
	);	
</update>

<!-- 매출계약  -->
<update id="deleteSP_Contract_R01_CONTRACT" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_CONTRACT
	UPDATE SALES_CONTRACT_LIST
	SET
		DELETE_FLAG = '1'
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{CONTRACT_NO};
</update>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_PROD_DET" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_PROD_DET
	INSERT INTO SALES_CONTRACT_PRODUCT_DETAIL
	(
		CONTRACT_NO,
		PRODUCT_CODE,
		PRODUCT_LIST,
		PLATFORM_LIST,
		FUNCTION_LIST,
		PURPOSE,
		ISDEV_FLAG,
		SERVER_GRADE,
		PRODUCT_TYPE,
		UNIT_COST,
		PRODUCT_UNIT,
		QUANTITY,
		CONTRACT_PRICE,
		REMARKS,  -- 기본 값 설정을 통해 여기에 항상 추가
		ORD,
		DELETE_FLAG
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM
	)
	VALUES
	(
		IFNULL(#{CONTRACT_NO}, #{varContractNo}),  -- NULL 체크로 변경
		#{PRODUCT_CODE},
		#{PRODUCT_LIST},
		#{PLATFORM_LIST},
		#{FUNCTION_LIST},
		#{PURPOSE},
		#{ISDEV_FLAG},
		#{SERVER_GRADE},
		#{PRODUCT_TYPE},
		IFNULL(#{UNIT_COST}, 0),  -- NULL 체크로 변경
		#{PRODUCT_UNIT},
		IFNULL(#{QUANTITY}, 0),  -- NULL 체크로 변경
		IFNULL(#{CONTRACT_PRICE}, 0),  -- NULL 체크로 변경
		#{REMARKS},  -- 항상 추가
		#{ORD},
		'0'  -- 기본 삭제 플래그 값
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	
	);

</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_PROD_DET" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_PROD_DET
	UPDATE SALES_CONTRACT_PRODUCT_DETAIL
	SET
		PRODUCT_CODE = #{PRODUCT_CODE},
		PRODUCT_LIST = #{PRODUCT_LIST},
		PLATFORM_LIST = #{PLATFORM_LIST},
		FUNCTION_LIST = #{FUNCTION_LIST},
		PURPOSE = #{PURPOSE},
		ISDEV_FLAG = #{ISDEV_FLAG},
		SERVER_GRADE = #{SERVER_GRADE},
		PRODUCT_TYPE = #{PRODUCT_TYPE},

		UNIT_COST = IFNULL(#{UNIT_COST}, 0),  -- NULL 체크로 변경

		PRODUCT_UNIT = #{PRODUCT_UNIT},

		QUANTITY = IFNULL(#{QUANTITY}, 0),  -- NULL 체크로 변경

		CONTRACT_PRICE = IFNULL(#{CONTRACT_PRICE}, 0),  -- NULL 체크로 변경

		REMARKS = IFNULL(#{REMARKS}, NULL),  -- NULL 체크로 변경

		ORD = #{ORD}
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CRD_SEQ = #{CRD_SEQ};

</update>	

<!-- 매출계약  -->
<update id="deleteSP_Contract_R01_CONTRACT_PROD_DET" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_CONTRACT_PROD_DET
	UPDATE SALES_CONTRACT_PRODUCT_DETAIL
	SET
	    DELETE_FLAG = '1'
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CRD_SEQ = #{CRD_SEQ};
</update>	
	
<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_SI_DET" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_SI_DET

	INSERT INTO SALES_CONTRACT_SI_DETAIL
	(
		CONTRACT_NO,
		ROLE_CODE,
		LEVEL_CODE,
		START_DATE,
		END_DATE,
		PERSON_NUMBER,
		UNIT_COST,
		CONTRACT_PRICE,
		MEN_MONTH,
		REMARKS,
		AREA_CODE,
		EXECUTION_TYPE,
		TECH_SUPPORT_UNIT,
		ORD,
		DELETE_FLAG
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	) VALUES
	(
		IFNULL(#{CONTRACT_NO},{#varContractNo}),
		#{ROLE_CODE},
		#{LEVEL_CODE},
		#{START_DATE},
		#{END_DATE},
		#{PERSON_NUMBER},
		
		COALESCE(#{UNIT_COST}, 0),
		COALESCE(#{CONTRACT_PRICE}, 0),
		
		#{MEN_MONTH},
		#{REMARKS},
		
		#{AREA_CODE},
		#{EXECUTION_TYPE},
		#{TECH_SUPPORT_UNIT},
		#{ORD},
		'0'
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	
	);
	
</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_SI_DET" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_SI_DET
	UPDATE SALES_CONTRACT_SI_DETAIL
	SET
		ROLE_CODE = #{ROLE_CODE},
		LEVEL_CODE = #{LEVEL_CODE},
		START_DATE = #{START_DATE},
		END_DATE = #{END_DATE},
		PERSON_NUMBER = #{PERSON_NUMBER},
		AREA_CODE = #{AREA_CODE},
		
		UNIT_COST = COALESCE(#{UNIT_COST}, 0),
		CONTRACT_PRICE = COALESCE(#{CONTRACT_PRICE}, 0),
		
		MEN_MONTH = #{MEN_MONTH},
		REMARKS = IFNULL(#{REMARKS}, NULL),
		
		EXECUTION_TYPE = #{EXECUTION_TYPE},
		TECH_SUPPORT_UNIT = #{TECH_SUPPORT_UNIT},
		ORD = #{ORD}
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CSD_SEQ = #{CSD_SEQ};
</update>

<!-- 매출계약  -->
<delete id="deleteSP_Contract_R01_CONTRACT_SI_DET" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_CONTRACT_SI_DET
	UPDATE SALES_CONTRACT_SI_DETAIL
	SET
		DELETE_FLAG = '1'
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CSD_SEQ = #{CSD_SEQ};	
</delete>	

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_CONTRACT_MA_DET" parameterType="java.util.Map">
	-- insertSP_Contract_R01_CONTRACT_MA_DET
	INSERT INTO SALES_CONTRACT_MA_DETAIL
	(
		CONTRACT_NO,
		PRODUCT_CODE,
		MA_PRODUCT_CODE,
		START_DATE,
		END_DATE,
		CONTRACT_PRICE,
		MA_RATE,
		<if test="REMARKS !=null and REMARKS != ''">
		REMARKS,
		</if>
		MA_STANDARD,
		ORD,
		PURCHASE_EXCEPT_FLAG,
		DELETE_FLAG
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	)
	VALUES
	(
		IFNULL(#{CONTRACT_NO},{#varContractNo}),
		#{PRODUCT_CODE},
		#{MA_PRODUCT_CODE},
		#{START_DATE},
		#{END_DATE},
		COALESCE(#{CONTRACT_PRICE}, 0),
		COALESCE(#{MA_RATE}, 0),
		<if test="REMARKS !=null and REMARKS != ''">
		#{REMARKS},
		</if>
		#{MA_STANDARD},
		#{ORD},
		'0',
		'0'
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	
	);

</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_CONTRACT_MA_DET" parameterType="java.util.Map">
	-- updateSP_Contract_R01_CONTRACT_MA_DET
	UPDATE SALES_CONTRACT_MA_DETAIL
	SET
	    PRODUCT_CODE = #{PRODUCT_CODE},
	    MA_PRODUCT_CODE = #{MA_PRODUCT_CODE},
	    START_DATE = #{START_DATE},
	    END_DATE = #{END_DATE},
		CONTRACT_PRICE = COALESCE(#{CONTRACT_PRICE}, 0),
		MA_RATE = COALESCE(#{MA_RATE}, 0),
		<if test="DELETE_FLAG !=null and DELETE_FLAG != ''">
			REMARKS = #{REMARKS},
		</if>
	    MA_STANDARD = #{MA_STANDARD},
	    ORD = #{ORD},
	    PURCHASE_EXCEPT_FLAG = #{PURCHASE_EXCEPT_FLAG}
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CMD_SEQ = #{CMD_SEQ};
</update>

<!-- 매출계약  -->
<update id="deleteSP_Contract_R01_CONTRACT_MA_DET" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_CONTRACT_MA_DET
	UPDATE SALES_CONTRACT_MA_DETAIL
	SET
		DELETE_FLAG = '1'
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CMD_SEQ = #{CMD_SEQ};
</update>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_Schedule" parameterType="java.util.Map">
	-- insertSP_Contract_R01_Schedule
	INSERT INTO SALES_SCHEDULE
	(
	    PROJECT_CODE,
	    CONTRACT_NO,
	    TYPE_CODE,
	    ISSUE_DATE,
	    REPORT_FLAG,
	    IMPORTANCE,
	    OPEN_FLAG,
	    CONTENTS  -- CONTENTS 필드 추가 (비어있지 않을 때 추가됨)
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	) VALUES (
	    #{PROJECT_CODE},
	
	    -- CONTRACT_NO 필드 조건부 추가
	    IFNULL(#{CONTRACT_NO}, #varContractNo#),  
	
	    #{TYPE_CODE},
	    #{ISSUE_DATE},
	    #{REPORT_FLAG},
	    #{IMPORTANCE},
	    #{OPEN_FLAG},
	    
	    -- CONTENTS 필드 조건부 추가
	    IFNULL(#{CONTENTS}, NULL)
	
		    ,#{EMP_NO_SRV}
		    ,#{USER_CON_IPADDR_SRV}
		    ,NOW()
		    ,#{EMP_NO_SRV}
		    ,#{USER_CON_IPADDR_SRV}
		    ,NOW()	
	);	
</insert>
	
<!-- 매출계약  -->
<update id="updateSP_Contract_R01_Schedule" parameterType="java.util.Map">
	-- updateSP_Contract_R01_Schedule
	UPDATE SALES_SCHEDULE
	SET
		TYPE_CODE = #{TYPE_CODE},
		ISSUE_DATE = #{ISSUE_DATE},
		REPORT_FLAG = #{REPORT_FLAG},
		IMPORTANCE = #{IMPORTANCE},
		OPEN_FLAG = #{OPEN_FLAG},

		-- CONTENTS 필드 조건부 업데이트
		CONTENTS = IFNULL(#{CONTENTS}, CONTENTS)  -- CONTENTS가 비어있지 않을 때만 업데이트

		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE
		SS_SEQ = #{SS_SEQ};		
</update>

<!-- 매출계약  -->
<delete id="deleteSP_Contract_R01_Schedule" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_Schedule
	DELETE FROM SALES_SCHEDULE 
	WHERE SS_SEQ = #{SS_SEQ};
</delete>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_Address" parameterType="java.util.Map">	
	-- insertSP_Contract_R01_Address
	INSERT INTO SALES_CA_MAP
	(
	    CA_SEQ,
	    SOURCE_CD,
	    SOURCE_DATA
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	) VALUES
	(
	    #{CA_SEQ},
	    #{SOURCE_CD},
	    #{SOURCE_DATA}
		    ,#{EMP_NO_SRV}
		    ,#{USER_CON_IPADDR_SRV}
		    ,NOW()
		    ,#{EMP_NO_SRV}
		    ,#{USER_CON_IPADDR_SRV}
		    ,NOW()	
	);
</insert>

<!-- 매출계약  -->
<update id="updateSP_Contract_R01_Address" parameterType="java.util.Map">	
	-- updateSP_Contract_R01_Address

	 UPDATE  SALES_COMPANY_ADDRESSBOOK
	 SET     
		ETAX_FLAG = #{ETAX_FLAG}
		 ,ORDER_FLAG = #{ORDER_FLAG}
		 ,GRADE_CODE = #{GRADE_CODE}
		 ,ROLE_CODE = #{ROLE_CODE}
		 ,H_PHONE_NO = #{H_PHONE_NO}
		 ,O_PHONE_NO = #{O_PHONE_NO}
		 ,EMAIL = #{EMAIL}
		 <if test="REMARKS !=null and REMARKS != ''">
		 ,REMARKS = #{REMARKS}
		 </if>
		 ,HISTORY = 
					SELECT CONCAT(
						DATE_FORMAT(NOW(), '%Y-%m-%d'), ' ', #{EMP_NO_SRV}, ' ',
						CASE
							WHEN IFNULL(CA.EMP_NAME, '') = IFNULL(#{EMP_NAME}, '') THEN ''
							ELSE CONCAT('이름 : ', IFNULL(CA.EMP_NAME, ''), ' → ', IFNULL(#{EMP_NAME}, ''), ' ')
						END,
						CASE
							WHEN IFNULL(CA.H_PHONE_NO, '') = IFNULL(#{H_PHONE_NO}, '') THEN ''
							ELSE CONCAT('휴대폰 : ', IFNULL(CA.H_PHONE_NO, ''), ' → ', IFNULL(#{H_PHONE_NO}, ''), ' ')
						END,
						CASE
							WHEN IFNULL(CA.O_PHONE_NO, '') = IFNULL(#{O_PHONE_NO}, '') THEN ''
							ELSE CONCAT('유선번호 : ', IFNULL(CA.O_PHONE_NO, ''), ' → ', IFNULL(#{O_PHONE_NO}, ''), ' ')
						END,
						CASE
							WHEN IFNULL(CA.EMAIL, '') = IFNULL(#{EMAIL}, '') THEN ''
							ELSE CONCAT('이메일 : ', IFNULL(CA.EMAIL, ''), ' → ', IFNULL(#{EMAIL}, ''), ' ')
						END
						)
						FROM SALES_COMPANY_ADDRESSBOOK CA
						WHERE CA.CA_SEQ = #{CA_SEQ}
					,
			, CHGE_ID = #{EMP_NO_SRV}
			, CHGE_IP = #{USER_CON_IPADDR_SRV}
			, CHGE_DTTM = NOW()
	 WHERE   CA_SEQ = #{CA_SEQ};
	 
	 <if test="SOURCE_DATA !=null and SOURCE_DATA != ''">
		 UPDATE  SALES_CA_MAP
		 SET     SOURCE_CD = #{SOURCE_CD}
		 ,SOURCE_DATA = #{SOURCE_DATA}
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
		 WHERE   CA_SEQ = #{CA_SEQ}
		 AND     SOURCE_CD = #{ORG_SOURCE_CD}
		 AND     SOURCE_DATA = #{ORG_SOURCE_DATA};
	 </if>
	
</update>

<!-- 매출계약  -->
<delete id="deleteSP_Contract_R01_Address" parameterType="java.util.Map">	
	-- deleteSP_Contract_R01_Address
	DELETE FROM    SALES_CA_MAP
	WHERE   CA_SEQ = #{CA_SEQ} 
	AND     SOURCE_CD = #{SOURCE_CD} 
	AND     SOURCE_DATA = #{SOURCE_DATA}
</delete>

<!-- 매출계약  -->
<insert id="insertSP_Contract_R01_MAUnion" parameterType="java.util.Map">
	-- insertSP_Contract_R01_MAUnion
	-- CONTRACT_MA_UNION 테이블에 데이터 삽입
	INSERT INTO SALES_CONTRACT_MA_UNION
	( 
		CONTRACT_NO
	, UNION_CONTRACT_NO
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	)
	VALUES (
	  IFNULL(#{CONTRACT_NO}, #{varContractNo})
	, #{UNION_CONTRACT_NO}
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	
	);

	-- 기술지원 상태를 '유상(006)'으로 업데이트
	UPDATE SALES_CONTRACT_PRODUCT
	SET SUPPORT_STATUS = '006'
	, SUPPORT_STOP_START_DATE = NULL
	, SUPPORT_STOP_END_DATE = NULL
	, SUPPORT_REMARKS = NULL
	, SUPPORT_STATUS_UPDATE_DATE = NOW()
	, SUPPORT_STATUS_UPDATE_EMP_NO = #{EMP_NO_SRV}
	, CHGE_ID = #{EMP_NO_SRV}
	, CHGE_IP = #{USER_CON_IPADDR_SRV}
	, CHGE_DTTM = NOW()	
	WHERE CONTRACT_NO = #{UNION_CONTRACT_NO};

	-- SUPPORT_STATUS_HISTORY 테이블에 기록 추가
	INSERT INTO SALES_SUPPORT_STATUS_HISTORY
	( CONTRACT_NO
	, SUPPORT_STATUS
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	)
	VALUES (
	  #{UNION_CONTRACT_NO}
	, '006'
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	
	);

</insert>

<update id="updateSP_Contract_R01_MAUnion" parameterType="java.util.Map">
	-- updateSP_Contract_R01_MAUnion
	-- CONTRACT_PRODUCT 테이블 업데이트
	UPDATE SALES_CONTRACT_PRODUCT
	SET SUPPORT_STATUS = #{SUPPORT_STATUS}
	, SUPPORT_STOP_START_DATE = #{SUPPORT_STOP_START_DATE}
	, SUPPORT_STOP_END_DATE = #{SUPPORT_STOP_END_DATE}
	, SUPPORT_REMARKS = CASE
		WHEN #{SUPPORT_REMARKS# IS NOT NULL THEN #{SUPPORT_REMARKS}
		ELSE NULL
	  END
	, SUPPORT_STATUS_UPDATE_EMP_NO = #gdsGlobal.EMP_NO}
	, SUPPORT_STATUS_UPDATE_DATE = NOW()
	, CHGE_ID = #{EMP_NO_SRV}
	, CHGE_IP = #{USER_CON_IPADDR_SRV}
	, CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{UNION_CONTRACT_NO};

	-- SUPPORT_STATUS_HISTORY 테이블에 기록 추가
	INSERT INTO SALES_SUPPORT_STATUS_HISTORY
	( CONTRACT_NO
	, SUPPORT_STATUS
	, SUPPORT_STOP_START_DATE
	, SUPPORT_STOP_END_DATE
	<if test="SUPPORT_REMARKS !=null and SUPPORT_REMARKS != ''">
	, SUPPORT_REMARKS
	</if>
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
	)
	VALUES (
	  #{UNION_CONTRACT_NO}
	, #{SUPPORT_STATUS}
	, #{SUPPORT_STOP_START_DATE}
	, #{SUPPORT_STOP_END_DATE}
	<if test="SUPPORT_REMARKS !=null and SUPPORT_REMARKS != ''">
		,#{SUPPORT_REMARKS}
	</if>
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()		
	);
</update>

<delete id="deleteSP_Contract_R01_MAUnion" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_MAUnion
	DELETE FROM SALES_CONTRACT_MA_UNION
	 WHERE CONTRACT_NO = #{CONTRACT_NO}
	 AND UNION_CONTRACT_NO = #{UNION_CONTRACT_NO}
</delete>

<insert id="insertSP_Contract_R01_Promise" parameterType="java.util.Map">
	-- insertSP_Contract_R01_Promise
	INSERT INTO SALES_CONTRACT_PROMISE
	( CONTRACT_NO
	, SUBJECT
	, PROMISE_DATE
	, LIMIT_DATE
	, PROMISE_KIND
	, CONTENTS
			,INPT_ID
			,INPT_IP
			,INPT_DTTM
			,CHGE_ID
			,CHGE_IP
			,CHGE_DTTM	
	)
	VALUES (
		IFNULL(#{CONTRACT_NO}, #{varContractNo})
	, #{SUBJECT}
	, #{PROMISE_DATE}
	, #{LIMIT_DATE}
	, #{PROMISE_KIND}
	, #{CONTENTS}
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()
			,#{EMP_NO_SRV}
			,#{USER_CON_IPADDR_SRV}
			,NOW()	
	);
	
</insert>

<update id="updateSP_Contract_R01_Promise" parameterType="java.util.Map">
	-- updateSP_Contract_R01_Promise
	UPDATE SALES_CONTRACT_PROMISE
	SET
	  SUBJECT = #{SUBJECT},
	  PROMISE_DATE = #{PROMISE_DATE},
	  LIMIT_DATE = #{LIMIT_DATE},
	  PROMISE_KIND = #{PROMISE_KIND},
	  <if test="CONTENTS !=null and CONTENTS != ''">
	  CONTENTS = #{CONTENTS},
	  </if>
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE
	  CP_SEQ = #{CP_SEQ};	
</update>

<delete id="deleteSP_Contract_R01_Promise" parameterType="java.util.Map">
	-- deleteSP_Contract_R01_Promise
	DELETE FROM SALES_CONTRACT_PROMISE
 	WHERE CP_SEQ = #{CP_SEQ}
</delete>

<insert id="insertSP_Contract_R01_Royalty" parameterType="java.util.Map">
	-- insertSP_Contract_R01_Royalty
	INSERT INTO ROYALTY_INFO
	( 
	  PROJECT_CODE, 
	  CONTRACT_NO, 
	  ROYALTY_SEQ, 
	  CONTRACT_NO_PURCHASE, 
	  ROYALTY_TYPE, 
	  ROYALTY_RATE, 
	  ROYALTY_DATE, 
	  ROYALTY_PRICE, 
	  NET_SALES_PRICE, 
	  CONFIRM_FLAG, 
	  EXCHAGE_STATUS, 
	  ROYALTY_REMARKS, 
	  REMARKS
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
	)
	VALUES
	( 
	  #{PROJECT_CODE},
	  #{CONTRACT_NO},
	  ( SELECT IFNULL( MAX(ROYALTY_SEQ), 0) + 1 
		FROM ROYALTY_INFO 
		WHERE PROJECT_CODE = #{PROJECT_CODE}
		AND CONTRACT_NO = #{CONTRACT_NO} ), 
	  #{CONTRACT_NO_PURCHASE},
	  #{ROYALTY_TYPE},
	  #{ROYALTY_RATE},
	  #{ROYALTY_DATE},
	  #{ROYALTY_PRICE},
	  #{NET_SALES_PRICE},
	  #{CONFIRM_FLAG},
	  #{EXCHAGE_STATUS},
	  #{ROYALTY_REMARKS},
	  #{REMARKS}
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()	
	);	 
</insert>

<update id="updateSP_Contract_R01_Royalty" parameterType="java.util.Map">
	-- updateSP_Contract_R01_Royalty
	UPDATE SALES_ROYALTY_INFO  
	SET 
	  ROYALTY_REMARKS = #{ROYALTY_REMARKS}
		,REMARKS = #{REMARKS}
	WHERE 
	  PROJECT_CODE = #{PROJECT_CODE} 
	  AND CONTRACT_NO = #{CONTRACT_NO} 
	  AND ROYALTY_SEQ = #{PROJECT_CODE};	
</update>

<update id="updateSP_Contract_R03" parameterType="java.util.Map">
	-- updateSP_Contract_R01_Royalty
	UPDATE SALES_CONTRACT_LIST
	SET 
	  CONTRACT_STATUS = '2'
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE 
	  CONTRACT_NO = #{CONTRACT_NO}
	  AND CONTRACT_STATUS = '3';
	
</update>

<select id="selectSP_Contract_S04_1" parameterType="java.util.List" resultType="java.util.Map">
	-- selectSP_Contract_S04_1
	SELECT CB_SEQ
	FROM CONTRACT_BILL
	WHERE CONTRACT_NO = #{CONTRACT_NO}
	AND (TAX_DATE IS NOT NULL OR BILL_DATE IS NOT NULL);	
</select>

<select id="selectSP_Contract_S04_2" parameterType="java.util.List" resultType="java.util.Map">
	-- selectSP_Contract_S04_2
	SELECT CB_SEQ,
		   CONTRACT_NO,
		   BILL_STATUS,
		   PAY_METHOD,
		   TAX_PRICE,
		   VAT_PRICE,
		   TAX_PLAN_DATE,
		   TAX_DATE,
		   BILL_PRICE,
		   BILL_PLAN_DATE,
		   BILL_DATE,
		   BILL_PROC_DATE,
		   BILL_EXCEPT_FLAG,
		   SITECHK_STATUS,
		   REMARKS,
		   REMARKS_UNBILL,
		   SITECHK_REMARKS
	FROM SALES_CONTRACT_BILL
	WHERE CONTRACT_NO = #{CONTRACT_NO};	
</select>


<update id="updateSP_Contract_R04" parameterType="java.util.Map">
	-- updateSP_Contract_R04
	UPDATE SALES_CONTRACT_BILL
	SET VAT_PRICE = TAX_PRICE / #{CONSUMPTION_TAX},
		, CHGE_ID = #{EMP_NO_SRV}
		, CHGE_IP = #{USER_CON_IPADDR_SRV}
		, CHGE_DTTM = NOW()
	WHERE CONTRACT_NO = #{CONTRACT_NO};	
</update>

<insert id="insertSP_Contract_R02" parameterType="java.util.Map">
	-- insertSP_Contract_R02
	-- 매출 계약
	INSERT INTO SALES_CONTRACT_LIST
	( 
		CONTRACT_NO
	, PROJECT_CODE
	, CO_CD
	, CONTRACT_TYPE
	, BUSINESS_TYPE
	, CONTRACT_NAME
	, PRODUCT_CODE
	, CONTRACT_DATE
	, SALES_EMP_NO
	, SALES_CO_CD
	, SALES_DEPT_CD
	, SALES_DEPT_NAME
	, INCENTIVE_EMP_NO
	, CONTRACT_STATUS
	, SALES_STATUS
	, PIPELINE_FLAG
	, CONTRACT_MAIN
	, SITECHK_FLAG
	, EXPORT_FLAG
	, PAY_METHOD
	, PREPAYMENT_EXECUTION_RATE
	, CONTRACT_EXECUTION_RATE
	, DEFECT_EXECUTION_RATE
	, PROGRESS_EXCEPT_FLAG
	, PROGRESS_100_FLAG
	, PROGRESS_ADD_FLAG
	, BAD_DEBT_FLAG
	, BAD_DEBT_DATE
	, COLLECTION_BOND_FLAG
	, NET_SALES_FLAG
	, DIVISION_FLAG
	, CLIENT_PO_NO
	, REMARKS
	, CONFIRM_EMP_NO
	, CONFIRM_DATE
	, DELETE_FLAG
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
	)
		SELECT #{NEW_CONTRACT_NO}
		, PROJECT_CODE
		, CO_CD
		, CONTRACT_TYPE
		, BUSINESS_TYPE
		, CONTRACT_NAME
		, PRODUCT_CODE
		, #{CONTRACT_DATE}
		, SALES_EMP_NO
		, SALES_CO_CD
		, SALES_DEPT_CD
		, SALES_DEPT_NAME
		, INCENTIVE_EMP_NO
		, CONTRACT_STATUS
		, SALES_STATUS
		, PIPELINE_FLAG
		, CONTRACT_MAIN
		, SITECHK_FLAG
		, EXPORT_FLAG
		, PAY_METHOD
		, PREPAYMENT_EXECUTION_RATE
		, CONTRACT_EXECUTION_RATE
		, DEFECT_EXECUTION_RATE
		, PROGRESS_EXCEPT_FLAG
		, PROGRESS_100_FLAG
		, PROGRESS_ADD_FLAG
		, BAD_DEBT_FLAG
		, BAD_DEBT_DATE
		, COLLECTION_BOND_FLAG
		, NET_SALES_FLAG
		, DIVISION_FLAG
		, CLIENT_PO_NO
		, REMARKS
		, #{EMP_NO_SRV}
		, NOW()
		, DELETE_FLAG
		,#{EMP_NO_SRV}
		,#{USER_CON_IPADDR_SRV}
		,NOW()
		,#{EMP_NO_SRV}
		,#{USER_CON_IPADDR_SRV}
		,NOW()		
		FROM SALES_CONTRACT_LIST
		WHERE CONTRACT_NO = #{CONTRACT_NO}
		AND DELETE_FLAG = '0';

	-- 유지보수계약
	INSERT INTO SALES_CONTRACT_MA
	( 
		CONTRACT_NO
	, START_DATE
	, END_DATE
	, UNION_FLAG
	, AUTO_EXTENSION_FLAG
	, REGULAR_VISIT
	, ATTACH
	, PUBLISHER
	, VIST_CYCLE
	, REQUEST_CYCLE
	, REQUEST_PRICE
	, REQUEST_MONTH
	, REQUEST_DAY
	, RESULT_DATE
	, AUTO_ISSUE_FLAG
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM
	)
	SELECT #{NEW_CONTRACT_NO}
	, DATE_ADD(START_DATE, INTERVAL 1 YEAR) AS START_DATE
	, GET_MA_END_DATE(DATE_ADD(END_DATE, INTERVAL 1 YEAR)) AS END_DATE
	, UNION_FLAG
	, AUTO_EXTENSION_FLAG
	, REGULAR_VISIT
	, ATTACH
	, PUBLISHER
	, VIST_CYCLE
	, REQUEST_CYCLE
	, REQUEST_PRICE
	, REQUEST_MONTH
	, REQUEST_DAY
	, #{CONTRACT_DATE}
	, IFNULL(AUTO_ISSUE_FLAG, '0')
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()		
	FROM SALES_CONTRACT_MA
	WHERE CONTRACT_NO = #{CONTRACT_NO};

	-- 계약 이력
	INSERT INTO SALES_CONTRACT_MA_HISTORY
	( 
		CONTRACT_NO
	, REGULAR_VISIT
	, VIST_CYCLE
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
	)
	SELECT #{NEW_CONTRACT_NO} AS CONTRACT_NO
	, REGULAR_VISIT
	, VIST_CYCLE
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()		
	FROM SALES_CONTRACT_MA
	WHERE CONTRACT_NO = #{CONTRACT_NO};

	-- 유지보수계약 상세
	INSERT INTO SALES_CONTRACT_MA_DETAIL
	( 
		CONTRACT_NO
	, PRODUCT_CODE
	, MA_PRODUCT_CODE
	, START_DATE
	, END_DATE
	, CONTRACT_PRICE
	, MA_RATE
	, MA_STANDARD
	, REMARKS
	, DELETE_FLAG
	, ORD
	, PURCHASE_EXCEPT_FLAG
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM
	)
	SELECT #{NEW_CONTRACT_NO}
	, PRODUCT_CODE
	, MA_PRODUCT_CODE
	, DATE_ADD(START_DATE, INTERVAL 1 YEAR) AS START_DATE
	, GET_MA_END_DATE(DATE_ADD(END_DATE, INTERVAL 1 YEAR)) AS END_DATE
	, CONTRACT_PRICE
	, MA_RATE
	, MA_STANDARD
	, REMARKS
	, DELETE_FLAG
	, ORD
	, '0'
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()	
	FROM SALES_CONTRACT_MA_DETAIL
	WHERE CONTRACT_NO = #{CONTRACT_NO}
	AND DELETE_FLAG = '0';

	-- 통합유지보수
	INSERT INTO SALES_CONTRACT_MA_UNION
	( 
	CONTRACT_NO
	, UNION_CONTRACT_NO
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
	)
	SELECT #{NEW_CONTRACT_NO}
	, UNION_CONTRACT_NO
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()	
	FROM SALES_CONTRACT_MA_UNION
	WHERE CONTRACT_NO = #{CONTRACT_NO};

	-- 계약 제품 업데이트
	UPDATE SALES_CONTRACT_PRODUCT
	SET SUPPORT_STATUS = '006'
	, SUPPORT_STOP_START_DATE = NULL
	, SUPPORT_STOP_END_DATE = NULL
	, SUPPORT_REMARKS = NULL
	, SUPPORT_STATUS_UPDATE_DATE = NOW()
	, SUPPORT_STATUS_UPDATE_EMP_NO = #{EMP_NO_SRV}
	, CHGE_ID = #{EMP_NO_SRV}
	, CHGE_IP = #{USER_CON_IPADDR_SRV}
	, CHGE_DTTM = NOW()	
	WHERE CONTRACT_NO IN (
		SELECT UNION_CONTRACT_NO
		FROM SALES_CONTRACT_MA_UNION
		WHERE CONTRACT_NO = #{CONTRACT_NO}
	);

	-- 지원 상태 이력 추가
	INSERT INTO SALES_SUPPORT_STATUS_HISTORY
	( 
		CONTRACT_NO
	, SUPPORT_STATUS
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
	)
	SELECT UNION_CONTRACT_NO
	, '006'
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()		
	FROM SALES_CONTRACT_MA_UNION
	WHERE CONTRACT_NO = #{CONTRACT_NO};

	-- 담당자 정보 추가 (조건에 따라)
	<if test="CA_COPY_FLAG !=null and CA_COPY_FLAG != '' and '1'.equals(CA_COPY_FLAG) ">
		INSERT INTO SALES_CA_MAP
		( 
		CA_SEQ
		, SOURCE_CD
		, SOURCE_DATA
		,INPT_ID
		,INPT_IP
		,INPT_DTTM
		,CHGE_ID
		,CHGE_IP
		,CHGE_DTTM	
		)
		SELECT CA_SEQ
		, SOURCE_CD
		, #{NEW_CONTRACT_NO} AS SOURCE_DATA
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()
	    ,#{EMP_NO_SRV}
	    ,#{USER_CON_IPADDR_SRV}
	    ,NOW()	
		FROM SALES_CA_MAP
		WHERE SOURCE_CD = 'CL'
		AND SOURCE_DATA = #{CONTRACT_NO};
	</if>
	
</insert>

<select id="selectSP_Contract_S05" resultType="string">
	-- selectSP_Contract_S05
	SELECT PPD.CMD_SEQ
	FROM SALES_PURCHASE_LIST PU
	JOIN SALES_PURCHASE_PRODUCT_DETAIL PPD ON (PU.CONTRACT_NO_PURCHASE = PPD.CONTRACT_NO_PURCHASE
	                                    AND PPD.DELETE_FLAG = '0'
	                                    AND PU.DELETE_FLAG = '0')
	WHERE PPD.CMD_SEQ IN (SELECT CMD_SEQ
	                      FROM SALES_CONTRACT_MA_DETAIL
	                      WHERE CONTRACT_NO = #{CONTRACT_NO});
</select>

<select id="selectSP_Contract_S06_1" resultType="string">
	-- selectSP_Contract_S06_1
	SELECT EM.EM_SEQ,
		   REPLACE(EM.CONTRACT_NAME, CHAR(10), '') AS CONTRACT_NAME,
		   EM.CONTRACT_MAIN,
		   COM.COMPANY_NAME AS CONTRACT_MAIN_NAME,
		   '009' AS SALES_STATUS,
		   DATE_FORMAT(EM.START_DATE, '%Y%m%d') AS START_DATE,
		   DATE_FORMAT(EM.END_DATE, '%Y%m%d') AS END_DATE,
		   EM.CONSUMPTION_TAX,
		   EM.PAY_METHOD
	FROM SALES_ESTIMATE_MANGEMENT EM
	LEFT JOIN SALES_COMPANY_LIST COM ON (EM.CONTRACT_MAIN = COM.COMPANY_CODE)
	WHERE EM.EM_SEQ = #{EM_SEQ};
</select>

<select id="selectSP_Contract_S06_2" resultType="string">
	-- selectSP_Contract_S06_2
	SELECT A.*,
		   PL.PRODUCT_NAME AS MA_MAIN_PRODUCT_NAME,
		   PL2.PRODUCT_NAME AS MA_PRODUCT_NAME
	FROM (
		SELECT EMD.EMD_SEQ,
			   EMD.EM_SEQ,
			   EMD.PRODUCT_CODE,
			   PL.MA_MAIN_PRODUCT_CODE,
			   'M01' AS MA_PRODUCT_CODE,
			   DATE_FORMAT(EM.START_DATE, '%Y%m%d') AS START_DATE,
			   DATE_FORMAT(EM.END_DATE, '%Y%m%d') AS END_DATE,
			   EMD.MA_RATE,
			   EMD.MA_STANDARD,
			   EMD.CONTRACT_PRICE
		FROM SALES_ESTIMATE_MANGEMENT_DET EMD
		JOIN SALES_ESTIMATE_MANGEMENT EM ON (EMD.EM_SEQ = EM.EM_SEQ)
		LEFT JOIN SALES_PRODUCT_LIST PL ON (EMD.PRODUCT_CODE = PL.PRODUCT_CODE)
		WHERE EMD.EM_SEQ = #{EM_SEQ}
	) A
	LEFT JOIN SALES_PRODUCT_LIST PL ON (A.MA_MAIN_PRODUCT_CODE = PL.PRODUCT_CODE)
	LEFT JOIN SALES_PRODUCT_LIST PL2 ON (A.MA_PRODUCT_CODE = PL2.PRODUCT_CODE);
	
</select>

<select id="selectSP_Contract_S06_3" resultType="string">
	-- selectSP_Contract_S06_3
	SELECT CPD.CONTRACT_NO AS UNION_CONTRACT_NO,
	       CL.CONTRACT_NAME AS UNION_CONTRACT_NAME,
	       PL.CLIENT_CODE,
	       COM.COMPANY_NAME AS CLIENT_NAME,
	       PL.PROJECT_CODE,
	       PL.PROJECT_NAME,
	       CL.PRODUCT_CODE,
	       PRL.PRODUCT_NAME
	FROM SALES_ESTIMATE_MANGEMENT_DET EMD
	JOIN SALES_CONTRACT_PRODUCT_DET CPD ON (EMD.CRD_SEQ = CPD.CRD_SEQ AND CPD.DELETE_FLAG = '0')
	JOIN SALES_CONTRACT_LIST CL ON (CPD.CONTRACT_NO = CL.CONTRACT_NO AND CL.DELETE_FLAG = '0')
	JOIN SALES_PROJECT_LIST PL ON (CL.PROJECT_CODE = PL.PROJECT_CODE AND PL.DELETE_FLAG = '0')
	LEFT JOIN SALES_COMPANY_LIST COM ON (PL.CLIENT_CODE = COM.COMPANY_CODE)
	LEFT JOIN SALES_PRODUCT_LIST PRL ON (CL.PRODUCT_CODE = PRL.PRODUCT_CODE)
	WHERE EMD.EM_SEQ = #{EM_SEQ}
	GROUP BY CPD.CONTRACT_NO,
	         CL.CONTRACT_NAME,
	         PL.CLIENT_CODE,
	         COM.COMPANY_NAME,
	         PL.PROJECT_CODE,
	         PL.PROJECT_NAME,
	         CL.PRODUCT_CODE,
	         PRL.PRODUCT_NAME;
</select>
</mapper>
